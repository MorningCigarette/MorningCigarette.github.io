---
title: "IIS中.net core和.net framework托管和非托管的对比"
description: 
slug: "iis_hosted_unhosted"
date: 2025-01-16
categories:
    - C#
---

在对比 **.NET Framework** 和 **.NET Core** 在托管和非托管代码上的处理时，需要考虑两者的运行机制以及在 IIS 中的配置差异。以下从运行时管理、托管与非托管代码支持、性能和场景等方面分析两者的区别：

------

## **托管与非托管代码概述**

- **托管代码**：
  - 由 **CLR（公共语言运行时）** 管理，运行时提供内存管理、垃圾回收、类型安全等功能。
  - 适用于使用 C#、VB.NET 等语言开发的代码。
  - 运行时环境：
    - **.NET Framework** 使用其自身的运行时 (.NET CLR)。
    - **.NET Core** 使用跨平台的 CoreCLR 或 .NET Runtime。
- **非托管代码**：
  - 不由 CLR 管理，直接与操作系统交互（例如原生 C/C++ 代码）。
  - 不享受 CLR 提供的功能，开发者需要自己处理内存分配、资源释放等。
  - 在 .NET Framework 和 .NET Core 中，可以通过 P/Invoke（平台调用）等方式调用非托管代码。

------

## **IIS 托管的差异**

### **.NET Framework**

- **运行机制**：
  - 在 IIS 中，**.NET Framework 应用程序**完全依赖 IIS 的托管功能。
  - IIS 加载指定版本的 .NET CLR（例如 v4.0），托管代码在 .NET CLR 中执行。
- **配置选项**：
  - **托管代码**：需要在应用程序池中选择对应的 ".NET CLR 版本"（如 v2.0 或 v4.0）。
  - **非托管代码**：设置为“无托管代码”，表示不加载 .NET CLR，IIS 仅用作运行非托管应用（如经典 ASP 或纯原生代码）。
- **特点**：
  - IIS 负责托管应用的生命周期和运行环境。
  - 强依赖于 Windows 和 .NET Framework，无法跨平台。

### **.NET Core**

- **运行机制**：
  - **.NET Core 应用程序**通过 **Kestrel Web Server** 运行。
  - IIS 仅作为反向代理，转发 HTTP 请求到 Kestrel，不直接托管代码。
  - .NET Core 的运行时独立于 IIS，可以跨平台运行。
- **配置选项**：
  - **托管代码**：无需选择 .NET CLR，推荐将“.NET CLR 版本”设置为“无托管代码”。
  - **非托管代码**：同样选择“无托管代码”，因为 .NET Core 自带运行时，IIS 只负责请求转发。
- **特点**：
  - 独立运行时（Self-contained Deployment）使其不依赖服务器上的 .NET 运行时。
  - 轻量级设计，更高性能，跨平台能力强。

------

## **性能对比**

| **特性**           | **.NET Framework**                                        | **.NET Core**                                                |
| ------------------ | --------------------------------------------------------- | ------------------------------------------------------------ |
| **托管代码性能**   | 较高，但受限于 IIS 和 Windows 平台。                      | 更高性能，Kestrel 比 IIS 更轻量，独立于平台运行。            |
| **非托管代码性能** | 支持 P/Invoke，但调用非托管代码时需要更高的资源管理成本。 | 同样支持 P/Invoke，性能优化更好，跨平台能力更强。            |
| **资源开销**       | IIS 加载 .NET CLR 时有一定的内存和启动开销。              | 不依赖 IIS 托管，运行时更轻量，仅用 IIS 作为反向代理时开销低。 |
| **启动速度**       | 较慢，依赖 IIS 初始化和加载 .NET CLR。                    | 较快，独立运行时不依赖 IIS 的初始化。                        |

------

## **适用场景对比**

| **场景**              | **.NET Framework**                                        | **.NET Core**                                     |
| --------------------- | --------------------------------------------------------- | ------------------------------------------------- |
| **传统 Windows 应用** | 适用于需要紧密集成 Windows 平台的应用（如企业内部系统）。 | 不适合传统依赖 Windows 的应用。                   |
| **跨平台 Web 应用**   | 不支持跨平台，运行时只能在 Windows 上。                   | 完美支持跨平台（Windows、Linux、macOS）。         |
| **高性能 Web 应用**   | 性能较低（受限于 IIS 的开销和托管模型）。                 | 性能更高，Kestrel 和反向代理的组合效率更优。      |
| **混合托管与非托管**  | 支持，但托管代码和非托管代码的交互需要注意性能损耗。      | 更高效，特别是在调用本机库时，P/Invoke 更加优化。 |

------

## **总结对比**

| **特性**         | **.NET Framework**                   | **.NET Core**                       |
| ---------------- | ------------------------------------ | ----------------------------------- |
| **托管模型**     | 强依赖 IIS 提供的托管环境            | 独立托管，通过 Kestrel 与 IIS 集成  |
| **运行时环境**   | 依赖 .NET CLR                        | 使用独立的 .NET Core 运行时         |
| **IIS 配置推荐** | 设置为对应 .NET CLR 版本             | 设置为“无托管代码”                  |
| **跨平台支持**   | 不支持                               | 完全支持跨平台                      |
| **性能**         | 较低（受限于 IIS 和 .NET Framework） | 更高（轻量级 Kestrel 和独立运行时） |

------

如果你的应用需要高性能、跨平台支持或轻量级架构，选择 **.NET Core** 是更优的方案。而如果你的应用是针对 Windows 平台的传统应用，且需要使用 .NET Framework 的完整功能，.NET Framework 会是合适的选择。
